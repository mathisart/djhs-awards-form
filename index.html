<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç”Ÿçæ‡²å ±è¡¨èˆ‡æ–‡ä»¶è‡ªå‹•åŒ–ç³»çµ±</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- è¼‰å…¥ html2pdf.js ç”¨æ–¼ç”Ÿæˆ PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" xintegrity="sha512-ZqB7gVlGzJ/3g6yT0mN7b3zM9+Zk3l2r09fC05yF0J5v2n7j2jR6u/r5L3z6p4d7Gg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f7f9fb;
        }
        .scrollable-content::-webkit-scrollbar { width: 8px; }
        .scrollable-content::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .scrollable-content::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .scrollable-content::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body>

<div id="app" class="min-h-screen p-4 sm:p-8">
    <div class="max-w-7xl mx-auto">

        <!-- æ¨™é¡Œèˆ‡ GAS é€£çµæç¤º -->
        <header class="mb-8 p-4 bg-white shadow-lg rounded-xl">
            <h1 class="text-3xl font-extrabold text-blue-800 mb-2 flex items-center">
                <i data-lucide="award" class="w-8 h-8 mr-3"></i>
                å­¸ç”Ÿçæ‡²å ±è¡¨èˆ‡æ–‡ä»¶è‡ªå‹•åŒ–ç³»çµ±
            </h1>
            <div id="gas-status-message" class="text-sm text-red-600 font-semibold p-2 bg-red-100 rounded-lg flex items-center">
                <i data-lucide="alert-triangle" class="w-5 h-5 mr-2"></i>
                é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ Apps Script éƒ¨ç½²ç‹€æ…‹/æ¬Šé™ã€‚
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- å·¦å´ï¼šå¡«å ±è¡¨å–® -->
            <div class="lg:col-span-1">
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                    <h2 class="text-2xl font-bold text-gray-700 mb-6">æ–°å¢ç²çåŒå­¸</h2>

                    <form id="award-form" class="space-y-4">
                        <!-- ç­ç´š -->
                        <div>
                            <label for="class" class="block text-sm font-medium text-gray-700">ç­ç´š</label>
                            <input type="text" id="class" name="class" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-blue-500 focus:ring-blue-500" placeholder="ä¾‹å¦‚ï¼š701">
                        </div>
                        
                        <!-- åº§è™Ÿ / å§“å -->
                        <div class="flex space-x-4">
                            <div class="flex-1">
                                <label for="seatNo" class="block text-sm font-medium text-gray-700">åº§è™Ÿ</label>
                                <input type="number" id="seatNo" name="seatNo" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-blue-500 focus:ring-blue-500" placeholder="ä¾‹å¦‚ï¼š15">
                            </div>
                            <div class="flex-1">
                                <label for="name" class="block text-sm font-medium text-gray-700">å§“å</label>
                                <input type="text" id="name" name="name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-blue-500 focus:ring-blue-500" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜">
                            </div>
                        </div>

                        <!-- ç™¼ç”Ÿæ—¥æœŸ -->
                        <div>
                            <label for="eventDate" class="block text-sm font-medium text-gray-700">ç™¼ç”Ÿæ—¥æœŸ</label>
                            <input type="date" id="eventDate" name="eventDate" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-blue-500 focus:ring-blue-500">
                        </div>

                        <!-- å¾—çåŸå›  -->
                        <div>
                            <label for="reason" class="block text-sm font-medium text-gray-700">å¾—çåŸå›  (äº‹ç”±)</label>
                            <textarea id="reason" name="reason" rows="3" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-blue-500 focus:ring-blue-500" placeholder="ä¾‹å¦‚ï¼šåƒåŠ å…¨åœ‹èªæ–‡ç«¶è³½æ¦®ç²åœ‹èªæœ—è®€ç‰¹å„ª"></textarea>
                        </div>
                        
                        <!-- æ•˜çå…§å®¹ -->
                        <div>
                            <label for="reward" class="block text-sm font-medium text-gray-700">çæ‡²ç¨®é¡ (æ•˜çå…§å®¹)</label>
                            <select id="reward" name="reward" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-blue-500 focus:ring-blue-500">
                                <option value="">è«‹é¸æ“‡</option>
                                <option value="å˜‰çä¸€æ¬¡">å˜‰çä¸€æ¬¡</option>
                                <option value="å˜‰çäºŒæ¬¡">å˜‰çäºŒæ¬¡</option>
                                <option value="å°åŠŸä¸€æ¬¡">å°åŠŸä¸€æ¬¡</option>
                                <option value="å°åŠŸäºŒæ¬¡">å°åŠŸäºŒæ¬¡</option>
                                <option value="ç„¡æ•˜ç(åƒ…è¡¨æš)">ç„¡æ•˜ç(åƒ…è¡¨æš)</option>
                            </select>
                        </div>

                        <button type="submit" id="submit-btn" class="w-full flex justify-center items-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                            <i data-lucide="plus-circle" class="w-5 h-5 mr-2"></i>
                            åŠ å…¥åå–® (å„²å­˜è‡³ Google Sheet)
                        </button>
                    </form>
                </div>
            </div>

            <!-- ä¸­é–“ï¼šå·²å¡«å ±åå–®åˆ—è¡¨ -->
            <div class="lg:col-span-2">
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 h-full">
                    <h2 class="text-2xl font-bold text-gray-700 mb-6 flex justify-between items-center">
                        å·²å¡«å ±åå–® (å…± <span id="award-count" class="text-blue-600">0</span> ç­†)
                    </h2>

                    <div id="award-list" class="space-y-4 max-h-[400px] overflow-y-auto pr-2 scrollable-content">
                        <p id="loading-message" class="text-center text-gray-500">å¾ Google Sheet è¼‰å…¥åå–®ä¸­...</p>
                    </div>
                    
                    <hr class="my-6">
                    
                    <h3 class="text-xl font-bold text-gray-700 mb-4">æ–‡ä»¶ç”¢å‡º</h3>
                    <div class="flex space-x-4">
                        <button id="generate-script-btn" class="flex-1 py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out disabled:bg-gray-400" disabled>
                            <i data-lucide="mic" class="w-5 h-5 inline-block mr-2"></i>
                            ä¸€ä»¶ç”¢å‡ºå¸å„€ç¨¿
                        </button>
                        <button id="generate-notice-btn" class="flex-1 py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out disabled:bg-gray-400" disabled>
                            <i data-lucide="file-text" class="w-5 h-5 inline-block mr-2"></i>
                            ä¸€ä»¶ç”¢å‡ºæ•˜çå…¬å‘Š (å»ºè­°è¡¨æ ¼å¼)
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Document Display -->
<div id="document-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
        <div class="p-6 border-b flex justify-between items-center">
            <h2 id="modal-title" class="text-2xl font-bold text-gray-800">æ–‡ä»¶ç”Ÿæˆ</h2>
            <button id="close-modal-btn" class="text-gray-500 hover:text-gray-700">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
        
        <div class="p-6 flex-grow overflow-hidden">
            <div class="h-full bg-gray-50 p-4 rounded-lg overflow-y-auto scrollable-content border border-gray-200">
                <div id="document-content" class="text-sm leading-relaxed text-gray-800"></div>
            </div>
        </div>

        <div class="p-4 border-t flex justify-between">
            <button id="generate-pdf-btn" class="flex items-center py-2 px-4 rounded-md text-sm font-medium text-white bg-red-600 hover:bg-red-700 transition duration-150 ease-in-out">
                <i data-lucide="file-text" class="w-5 h-5 mr-2"></i>
                ç”¢ç”Ÿ PDF æ–‡ä»¶
            </button>
            <button id="copy-document-btn" class="flex items-center py-2 px-4 rounded-md text-sm font-medium text-white bg-teal-600 hover:bg-teal-700 transition duration-150 ease-in-out">
                <i data-lucide="clipboard" class="w-5 h-5 mr-2"></i>
                è¤‡è£½æ–‡ä»¶å…§å®¹ (ç´”æ–‡å­—)
            </button>
        </div>
    </div>
</div>

<script>
    // ğŸš¨ğŸš¨ğŸš¨ è«‹å°‡æ­¤è™•æ›¿æ›ç‚ºæ‚¨éƒ¨ç½²çš„ Google Apps Script Web App ç¶²å€ ğŸš¨ğŸš¨ğŸš¨
    const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzRJTy0Vksb2l7vnBVKLN5Ln8ZawLZp7SPV--SSY6UAqJZzW7WNIFjEmgdVUbWKT7H7/exec'; 

    let awardees = []; // å„²å­˜å¾ Google Sheet è®€å–åˆ°çš„åå–®

    // --- è¼”åŠ©å‡½å¼èˆ‡ DOM å…ƒç´ å­˜å– ---
    const form = document.getElementById('award-form');
    const submitBtn = document.getElementById('submit-btn');
    const awardListContainer = document.getElementById('award-list');
    const awardCountSpan = document.getElementById('award-count');
    const loadingMessage = document.getElementById('loading-message');
    const generateScriptBtn = document.getElementById('generate-script-btn');
    const generateNoticeBtn = document.getElementById('generate-notice-btn');
    const gasStatusMessage = document.getElementById('gas-status-message');

    // Modal å…ƒç´ 
    const modal = document.getElementById('document-modal');
    const modalTitle = document.getElementById('modal-title');
    const documentContent = document.getElementById('document-content');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const copyDocumentBtn = document.getElementById('copy-document-btn');
    const generatePdfBtn = document.getElementById('generate-pdf-btn');

    /**
     * æ ¹æ“šçæ‡²ç¨®é¡è‡ªå‹•åˆ¤æ–·æ³•æ¢ä¾æ“šã€‚
     * é€™è£¡çš„é‚è¼¯å¿…é ˆå’Œ Code.gs ä¸­çš„é‚è¼¯ä¿æŒä¸€è‡´
     * @param {string} reward - çæ‡²ç¨®é¡
     * @returns {string} æ³•æ¢ä¾æ“š
     */
    const getBasis = (reward) => {
        // ğŸš¨ å‰ç«¯å¢åŠ ç©ºå€¼æª¢æŸ¥
        if (typeof reward !== 'string' || !reward) {
            return 'ç„¡';
        }

        // é‚è¼¯å·²æ›´æ–°ï¼šåŒ…å« 'å˜‰ç' -> å˜‰çæ³•æ¢; åŒ…å« 'å°åŠŸ' -> å°åŠŸæ³•æ¢
        if (reward.includes('å˜‰ç')) {
            return 'ç¬¬å››æ¢ç¬¬åå…­æ¬¾';
        } else if (reward.includes('å°åŠŸ')) { 
            return 'ç¬¬äº”æ¢ç¬¬åäºŒæ¬¾';
        } else {
            return 'ç„¡';
        }
    };

    // æ ¼å¼åŒ–ç™¼ç”Ÿæ—¥æœŸç‚º æœˆ/æ—¥
    const formatEventDate = (dateString) => {
        if (!dateString) return '';
        try {
            // å‡è¨­è¼¸å…¥æ˜¯ YYYY-MM-DD
            const parts = dateString.split('-');
            if (parts.length === 3) {
                const month = parts[1];
                const day = parts[2];
                return `${month} / ${day}`;
            }
        } catch (e) {
            console.error('Date format error:', e);
            return '';
        }
    };
    
    // --- æ ¸å¿ƒè³‡æ–™è®€å–èˆ‡æ¸²æŸ“ ---

    // è®€å–åå–®
    const fetchAwardees = async () => {
        loadingMessage.textContent = 'å¾ Google Sheet è¼‰å…¥åå–®ä¸­...';
        
        if (GAS_WEB_APP_URL.includes('YOUR_DEPLOYED_GAS_WEB_APP_URL_HERE')) {
            loadingMessage.textContent = 'âŒ è«‹å…ˆéƒ¨ç½² GAS Web App ä¸¦æ›´æ–° GAS_WEB_APP_URLã€‚';
            return;
        }

        try {
            const response = await fetch(GAS_WEB_APP_URL, {
                method: 'GET',
                mode: 'cors'
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            
            // æª¢æŸ¥ GAS å¾Œç«¯æ˜¯å¦å›å‚³éŒ¯èª¤è¨Šæ¯
            if (data.status === 'error') {
                 throw new Error(data.message || 'GAS å¾Œç«¯å›å‚³éŒ¯èª¤ã€‚');
            }
            
            // å‡è¨­ data.data æ˜¯ä¸€å€‹åŒ…å«åå–®ç‰©ä»¶çš„é™£åˆ—
            awardees = data.data || [];
            
            // ä¾ç­ç´š/åº§è™Ÿæ’åº (GAS ç«¯é€šå¸¸å·²ç¶“æ’å¥½ï¼Œä½†å‰ç«¯å†æ’ä¸€æ¬¡ç¢ºä¿)
            awardees.sort((a, b) => {
                if (a.class < b.class) return -1;
                if (a.class > b.class) return 1;
                return (a.seatNo || 0) - (b.seatNo || 0);
            });

            gasStatusMessage.className = 'text-sm text-green-600 font-semibold p-2 bg-green-100 rounded-lg flex items-center';
            gasStatusMessage.innerHTML = '<i data-lucide="check-circle" class="w-5 h-5 mr-2"></i> ç‹€æ…‹ï¼šå·²æˆåŠŸé€£ç·šè‡³ Google Sheetsã€‚';

        } catch (error) {
            console.error("Error fetching awardees:", error);
            // æª¢æŸ¥æ˜¯å¦ç‚º CORS éŒ¯èª¤ (æœ€å¸¸è¦‹çš„ GAS æ¬Šé™å•é¡Œ)
            let errorMessage = error.message;
            if (errorMessage.includes('Failed to fetch') || errorMessage.includes('HTTP error! status: 401')) {
                 errorMessage = 'è«‹ç¢ºèª Apps Script éƒ¨ç½²æ¬Šé™æ˜¯å¦è¨­ç‚ºã€Œä»»ä½•äººå¯å­˜å–ã€';
            } else if (errorMessage.includes('GAS å¾Œç«¯å›å‚³éŒ¯èª¤')) {
                 errorMessage = 'è«‹æª¢æŸ¥ Google Sheets ä¸­çš„å·¥ä½œè¡¨åç¨±æ˜¯å¦ç‚ºã€Œç²çåå–®ã€';
            }
            
            loadingMessage.textContent = `âŒ è¼‰å…¥åå–®å¤±æ•—: ${errorMessage}`;
            gasStatusMessage.className = 'text-sm text-red-600 font-semibold p-2 bg-red-100 rounded-lg flex items-center';
            gasStatusMessage.innerHTML = '<i data-lucide="alert-triangle" class="w-5 h-5 mr-2"></i> é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ Apps Script éƒ¨ç½²ç‹€æ…‹/æ¬Šé™ã€‚';
            awardees = [];
        } finally {
            renderAwardList();
        }
    };


    // æ¸²æŸ“åå–®åˆ—è¡¨
    const renderAwardList = () => {
        awardListContainer.innerHTML = '';
        awardCountSpan.textContent = awardees.length;

        // æŒ‰éˆ•å•Ÿç”¨æ¢ä»¶: æœ‰è³‡æ–™ AND æˆåŠŸé€£ç·š
        const isReady = GAS_WEB_APP_URL.includes('https'); // å‡è¨­åªè¦å¡«äº†ç¶²å€å°±å˜—è©¦å•Ÿç”¨
        generateScriptBtn.disabled = awardees.length === 0 || !isReady;
        generateNoticeBtn.disabled = awardees.length === 0 || !isReady;
        
        if (awardees.length === 0) {
            awardListContainer.innerHTML = '<p class="text-center text-gray-500 p-4 bg-gray-50 rounded-lg">å°šç„¡ç²çåå–®ï¼Œè«‹ä½¿ç”¨ä¸Šæ–¹è¡¨å–®æ–°å¢ã€‚</p>';
        }

        awardees.forEach(item => {
            // ç¢ºä¿ item.reward å­˜åœ¨ï¼Œå¦å‰‡å‚³å…¥ç©ºå­—ä¸²
            const basisText = getBasis(item.reward || '');
            const formattedDate = formatEventDate(item.eventDate);

            const div = document.createElement('div');
            div.className = 'bg-gray-50 p-4 rounded-lg shadow-sm flex justify-between items-center transition hover:bg-gray-100';
            div.innerHTML = `
                <div>
                    <p class="text-base font-semibold text-blue-700">${item.class} ${item.seatNo} è™Ÿ ${item.name}</p>
                    <p class="text-xs text-gray-600 mt-1">
                        <span class="inline-block bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full">${item.reward || 'ç„¡çæ‡²'}</span>
                        <span class="inline-block bg-gray-200 text-gray-600 text-xs font-medium px-2.5 py-0.5 rounded-full">${basisText}</span>
                        <span class="inline-block bg-gray-200 text-gray-600 text-xs font-medium px-2.5 py-0.5 rounded-full">${formattedDate}</span>
                        ${item.reason}
                    </p>
                </div>
                <!-- åˆªé™¤åŠŸèƒ½éœ€è¦ GAS è¤‡é›œè™•ç†ï¼Œæš«æ™‚ç§»é™¤æŒ‰éˆ• -->
            `;
            awardListContainer.appendChild(div);
        });
        lucide.createIcons();
    };

    // --- è¡¨å–®æäº¤èˆ‡è³‡æ–™å¯«å…¥ (POST åˆ° GAS) ---
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (GAS_WEB_APP_URL.includes('YOUR_DEPLOYED_GAS_WEB_APP_URL_HERE')) {
            showTemporaryMessage('è«‹å…ˆéƒ¨ç½² GAS Web App ä¸¦æ›´æ–° GAS_WEB_APP_URLï¼', 'error');
            return;
        }
        
        submitBtn.disabled = true;
        submitBtn.textContent = 'å„²å­˜ä¸­...';

        const formData = new FormData(form);
        const rewardValue = formData.get('reward');

        const newAward = {
            class: formData.get('class').trim(),
            seatNo: parseInt(formData.get('seatNo'), 10),
            name: formData.get('name').trim(),
            eventDate: formData.get('eventDate'),
            reason: formData.get('reason').trim(),
            reward: rewardValue,
            basis: getBasis(rewardValue) // å‰ç«¯è¨ˆç®—æ³•æ¢
        };
        
        try {
            const response = await fetch(GAS_WEB_APP_URL, {
                method: 'POST',
                mode: 'cors',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(newAward)
            });

            const result = await response.json();

            if (response.ok && result.status === 'success') {
                // æ›¿æ›æˆè‡ªå®šç¾© Modal æç¤º (é¿å… alert)
                showTemporaryMessage('åå–®å·²æˆåŠŸå„²å­˜åˆ° Google Sheetsï¼', 'success');
                form.reset();
                // é‡æ–°è®€å–åå–®ä»¥æ›´æ–°åˆ—è¡¨
                await fetchAwardees(); 
            } else {
                throw new Error(result.message || 'å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ GAS ç¨‹å¼ç¢¼ã€‚');
            }

        } catch (error) {
            console.error("Error submitting data: ", error);
            showTemporaryMessage(`æ–°å¢åå–®å¤±æ•—: ${error.message}`, 'error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i data-lucide="plus-circle" class="w-5 h-5 mr-2"></i>åŠ å…¥åå–® (å„²å­˜è‡³ Google Sheet)';
            lucide.createIcons();
        }
    });
    
    // è‡¨æ™‚è¨Šæ¯é¡¯ç¤º (å–ä»£ alert)
    const showTemporaryMessage = (message, type) => {
        const tempDiv = document.createElement('div');
        tempDiv.className = `fixed top-4 right-4 p-4 rounded-lg shadow-xl text-white font-bold transition-opacity duration-300 z-50 ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}`;
        tempDiv.textContent = message;
        document.body.appendChild(tempDiv);
        setTimeout(() => {
            tempDiv.style.opacity = '0';
            setTimeout(() => tempDiv.remove(), 300);
        }, 3000);
    };


    // --- æ–‡ä»¶è‡ªå‹•ç”Ÿæˆé‚è¼¯ (æ ¸å¿ƒ) ---
    
    // å¸å„€ç¨¿ç”Ÿæˆ (è¼¸å‡º HTML æ ¼å¼)
    const generateEmceeScript = () => {
        // ç¢ºä¿ä½¿ç”¨æœ€æ–°çš„ awardees è³‡æ–™
        let script = "<h2>ğŸ† é ’çå…¸ç¦®å¸å„€ç¨¿ (å½™æ•´è‰ç¨¿)</h2><p style='color: #ef4444;'>è«‹æ‰‹å‹•é¸å–å…§å®¹è¤‡è£½ï¼Œè²¼è‡³ Google æ–‡ä»¶ä»¥ä¿ç•™æ ¼å¼ã€‚</p><hr class='my-4 border-gray-300'>";
        script += "<p style='font-style: italic; color: #4b5563;'>--- å…¸ç¦®é–‹å§‹ | å¸å„€å£å» ---</p><br>";
        
        awardees.forEach((item, index) => {
            const template = `<div style="margin-bottom: 20px; padding: 15px; border-left: 5px solid #3b82f6; background-color: #eff6ff; border-radius: 5px;">` +
                             `<p style="font-size: 1.2em; line-height: 1.6; font-weight: 700;">` +
                             `<b>${item.class} ç­ ${item.name}</b>` +
                             ` ${item.reason}ï¼Œ` + 
                             `æ­è«‹æ ¡é•·é ’çï¼` +
                             `</p>` +
                             `<p style="font-style: italic; color: #4b5563; margin-top: 5px; font-size: 0.9em;">(${index + 1}. è«‹æ…¢é€Ÿã€æ¸…æ™°åœ°å®£è®€)</p>` +
                             `</div>`;
            script += template;
        });

        script += "<p style='font-style: italic; color: #4b5563;'>--- é ’çç’°ç¯€çµæŸï¼Œè«‹æŒè²é¼“å‹µæ‰€æœ‰ç²çåŒå­¸ï¼ ---</p>";
        return script;
    };

    // æ•˜çé€šçŸ¥ç”Ÿæˆ (è¼¸å‡º HTML è¡¨æ ¼æ ¼å¼ - ä¾æ“šä½¿ç”¨è€…æä¾›çš„åœ–è¡¨)
    const generateCommendationNotice = () => {
        const tableCellStyle = "border: 1px solid black; padding: 8px; vertical-align: middle; white-space: normal;";
        
        const currentDate = new Date();
        const year = currentDate.getFullYear() - 1911;
        const month = (currentDate.getMonth() + 1).toString().padStart(2, '0');
        const day = currentDate.getDate().toString().padStart(2, '0');
        const dateHeader = `ä¸­è¯æ°‘åœ‹ ${year} å¹´ ${month} æœˆ ${day} æ—¥`;

        let notice = `<div id="commendation-notice-content" style="padding: 20px; font-family: 'Noto Sans TC', sans-serif; max-width: 100%; overflow-x: auto;">
            <p style='color: #ef4444; margin-bottom: 20px;'>è«‹æ‰‹å‹•é¸å–å…§å®¹è¤‡è£½ï¼Œè²¼è‡³ Google æ–‡ä»¶ä»¥ä¿ç•™æ ¼å¼ã€‚</p>
            <h2 style="font-size: 1.5em; font-weight: bold; text-align: center; margin-bottom: 10px;">è‡ºä¸­å¸‚ç«‹å¤§ç”²åœ‹æ°‘ä¸­å­¸å­¸ç”Ÿçæ‡²å»ºè­°è¡¨(å…¬å‘Š)</h2>
            <div style="text-align: right; margin-bottom: 15px; font-size: 0.9em;">${dateHeader} (è«‹ä¿®æ”¹ç‚ºå…¬å‘Šæ—¥æœŸ)</div>

            <table style="width: 100%; border-collapse: collapse; text-align: center; font-size: 0.9em; border: 2px solid black;">
                <thead>
                    <tr style="background-color: #f0f0f0; font-weight: bold; height: 50px;">
                        <td style="${tableCellStyle} width: 7%;">ç­ç´š</td>
                        <td style="${tableCellStyle} width: 7%;">åº§è™Ÿ</td>
                        <td style="${tableCellStyle} width: 10%;">å§“ å</td>
                        <td style="${tableCellStyle} width: 5%;">ç™¼ç”Ÿæ—¥æœŸ<br>æœˆ</td>
                        <td style="${tableCellStyle} width: 5%;">ç™¼ç”Ÿæ—¥æœŸ<br>æ—¥</td>
                        <td style="${tableCellStyle} width: 35%;">äº‹ ç”±</td>
                        <td style="${tableCellStyle} width: 15%;">ä¾æ“šçæ‡²æ³•<br>æ¢ã€æ¬¾</td>
                        <td style="${tableCellStyle} width: 12%;">çæ‡²ç¨®é¡</td>
                        <td style="${tableCellStyle} width: 9%;">æœƒç°½ï¼šæœ‰é—œå°å¸«</td>
                    </tr>
                </thead>
                <tbody>`;

        if (awardees.length === 0) {
            notice += `<tr><td style="${tableCellStyle} height: 40px;" colspan="9">ç„¡è³‡æ–™å¯ä¾›ç”Ÿæˆã€‚</td></tr>`; 
        } else {
            awardees.forEach(item => {
                const formattedDate = formatEventDate(item.eventDate);
                const [itemMonth, itemDay] = formattedDate ? formattedDate.split(' / ') : ['', ''];
                // ç¢ºä¿ item.reward å­˜åœ¨ï¼Œå¦å‰‡å‚³å…¥ç©ºå­—ä¸²
                const basisText = getBasis(item.reward || '');

                notice += `<tr style="height: 40px;">
                    <td style="${tableCellStyle}">${item.class}</td>
                    <td style="${tableCellStyle}">${item.seatNo}</td>
                    <td style="${tableCellStyle}">${item.name}</td>
                    <td style="${tableCellStyle} text-align: center;">${itemMonth || ''}</td>
                    <td style="${tableCellStyle} text-align: center;">${itemDay || ''}</td>
                    <td style="${tableCellStyle} text-align: left; padding-left: 10px;">${item.reason}</td>
                    <td style="${tableCellStyle}">${basisText}</td>
                    <td style="${tableCellStyle} font-weight: bold;">${item.reward}</td>
                    <td style="${tableCellStyle}"></td> <!-- æœƒç°½: ç•™ç©º -->
                </tr>`;
            });
        }

        notice += `</tbody></table>
        
        <div style="margin-top: 30px; font-size: 0.9em;">
            <p style="text-align: center; margin-bottom: 15px; font-weight: bold; padding: 10px 0; border-top: 1px solid black; border-bottom: 1px solid black;">
                å°å¸«æœƒç°½å¾Œè«‹è½‰çŸ¥å­¸ç”Ÿèˆ‡å®¶é•·ï¼Œå¦‚æœ‰å•é¡Œè«‹æ´½å­¸å‹™è™•ç”Ÿæ´»æ•™è‚²çµ„ã€‚
            </p>
            <table style="width: 100%; border: none; border-collapse: collapse; text-align: center;">
                <tr>
                    <td style="width: 25%; border: none; padding: 20px 0;"><b>ç°½å ±äººï¼š</b></td>
                    <td style="width: 25%; border: none;"><b>ç”Ÿæ´»æ•™è‚²çµ„é•·ï¼š</b></td>
                    <td style="width: 25%; border: none;"><b>å­¸å‹™ä¸»ä»»ï¼š</b></td>
                    <td style="width: 25%; border: none;"><b>æ ¡ é•·ï¼š</b></td>
                </tr>
            </table>
        </div>
        </div>`;
        
        return notice;
    };
    
    // é¡¯ç¤º Modal
    const showModal = (title, content) => {
        modalTitle.textContent = title;
        documentContent.innerHTML = content; 
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        lucide.createIcons();
    };

    // éš±è— Modal
    const hideModal = () => {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    };
    
    // PDF ç”Ÿæˆå‡½å¼
    const generatePDF = (filename) => {
        const element = document.getElementById('document-content');
        const printContent = document.createElement('div');
        printContent.innerHTML = element.innerHTML;
        
        let targetElement = printContent.querySelector('#commendation-notice-content');
        if (!targetElement) { targetElement = printContent; }
        
        const prompt = targetElement.querySelector('p[style*="color: #ef4444"]');
        if (prompt) prompt.remove();

        const opt = {
            margin: 10,
            filename: filename,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, logging: false, allowTaint: true, useCORS: false },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        html2pdf().set(opt).from(targetElement).save();
    };

    // è¤‡è£½æ–‡å­—åŠŸèƒ½
    const copyToClipboard = () => {
        const pureText = documentContent.innerText || documentContent.textContent;
        const textarea = document.createElement('textarea');
        textarea.value = pureText;
        textarea.style.position = 'fixed';
        textarea.style.opacity = 0;
        document.body.appendChild(textarea);
        textarea.select();
        try {
            document.execCommand('copy');
            copyDocumentBtn.textContent = 'å·²è¤‡è£½!';
            setTimeout(() => {
                copyDocumentBtn.innerHTML = '<i data-lucide="clipboard" class="w-5 h-5 mr-2"></i>è¤‡è£½æ–‡ä»¶å…§å®¹ (ç´”æ–‡å­—)';
                lucide.createIcons();
            }, 1500);
        } catch (err) {
            console.error('Fallback: Copy failed', err);
        }
        document.body.removeChild(textarea);
    };

    // --- äº‹ä»¶ç›£è½èˆ‡åˆå§‹åŒ– ---
    generateScriptBtn.addEventListener('click', () => {
        const script = generateEmceeScript();
        showModal('è‡ªå‹•ç”Ÿæˆï¼šå¸å„€ç¨¿', script);
    });

    generateNoticeBtn.addEventListener('click', () => {
        const notice = generateCommendationNotice();
        showModal('è‡ªå‹•ç”Ÿæˆï¼šæ•˜çå…¬å‘Š (å»ºè­°è¡¨æ ¼å¼)', notice);
    });
    
    closeModalBtn.addEventListener('click', hideModal);
    copyDocumentBtn.addEventListener('click', copyToClipboard);
    generatePdfBtn.addEventListener('click', () => {
        const title = modalTitle.textContent.replace('è‡ªå‹•ç”Ÿæˆï¼š', '');
        generatePDF(`${title}_${Date.now()}.pdf`);
    });

    window.onload = () => {
        lucide.createIcons();
        fetchAwardees(); // é é¢è¼‰å…¥æ™‚å¾ Google Sheet è®€å–è³‡æ–™
    };

</script>
</body>
</html>
