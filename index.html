<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç²çåå–®å¡«å ±èˆ‡æ–‡ä»¶è‡ªå‹•ç”¢å‡ºç³»çµ±</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- è¼‰å…¥ html2pdf.js ç”¨æ–¼ç”Ÿæˆ PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" xintegrity="sha512-ZqB7gVlGzJ/3g6yT0wN7b3zM9+Zk3l2r09fC05yF0J5v2n7j2jR6u/r5L3z6p4d7Gg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f7f9fb;
        }
        /* è‡ªå®šç¾©æ»¾å‹•æ¢æ¨£å¼ï¼Œè®“æ–‡ä»¶ç”Ÿæˆå€å¡Šæ›´å¥½çœ‹ */
        .scrollable-content::-webkit-scrollbar {
            width: 8px;
        }
        .scrollable-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .scrollable-content::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        .scrollable-content::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body>

<div id="app" class="min-h-screen p-4 sm:p-8">
    <div class="max-w-7xl mx-auto">

        <!-- æ¨™é¡Œèˆ‡ç”¨æˆ¶ ID é¡¯ç¤º -->
        <header class="mb-8 p-4 bg-white shadow-lg rounded-xl">
            <h1 class="text-3xl font-extrabold text-blue-800 mb-2 flex items-center">
                <i data-lucide="award" class="w-8 h-8 mr-3"></i>
                ç²çåå–®å¡«å ±èˆ‡æ–‡ä»¶è‡ªå‹•ç”¢å‡ºç³»çµ±
            </h1>
            <p id="user-info" class="text-sm text-gray-500">
                <i data-lucide="user" class="w-4 h-4 inline-block mr-1"></i>
                ç”¨æˆ¶ ID (ç”¨æ–¼å…±äº«/è¿½è¹¤): è¼‰å…¥ä¸­...
            </p>
            <div id="auth-status" class="text-sm text-red-500 mt-2"></div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- å·¦å´ï¼šå¡«å ±è¡¨å–® -->
            <div class="lg:col-span-1">
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                    <h2 class="text-2xl font-bold text-gray-700 mb-6">æ–°å¢ç²çåŒå­¸</h2>

                    <form id="award-form" class="space-y-4">
                        <!-- ç­ç´š -->
                        <div>
                            <label for="class" class="block text-sm font-medium text-gray-700">ç­ç´š</label>
                            <input type="text" id="class" name="class" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-blue-500 focus:ring-blue-500" placeholder="ä¾‹å¦‚ï¼š701">
                        </div>
                        
                        <!-- åº§è™Ÿ -->
                        <div class="flex space-x-4">
                            <div class="flex-1">
                                <label for="seatNo" class="block text-sm font-medium text-gray-700">åº§è™Ÿ</label>
                                <input type="number" id="seatNo" name="seatNo" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-blue-500 focus:ring-blue-500" placeholder="ä¾‹å¦‚ï¼š15">
                            </div>
                            
                            <!-- å§“å -->
                            <div class="flex-1">
                                <label for="name" class="block text-sm font-medium text-gray-700">å§“å</label>
                                <input type="text" id="name" name="name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-blue-500 focus:ring-blue-500" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜">
                            </div>
                        </div>

                        <!-- ç™¼ç”Ÿæ—¥æœŸ (æ–°å¢) -->
                        <div>
                            <label for="eventDate" class="block text-sm font-medium text-gray-700">ç™¼ç”Ÿæ—¥æœŸ</label>
                            <input type="date" id="eventDate" name="eventDate" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-blue-500 focus:ring-blue-500">
                        </div>

                        <!-- å¾—çåŸå›  -->
                        <div>
                            <label for="reason" class="block text-sm font-medium text-gray-700">å¾—çåŸå›  (äº‹ç”±)</label>
                            <textarea id="reason" name="reason" rows="3" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-blue-500 focus:ring-blue-500" placeholder="ä¾‹å¦‚ï¼šåƒåŠ å…¨åœ‹èªæ–‡ç«¶è³½æ¦®ç²åœ‹èªæœ—è®€ç‰¹å„ª"></textarea>
                        </div>
                        
                        <!-- æ•˜çå…§å®¹ -->
                        <div>
                            <label for="reward" class="block text-sm font-medium text-gray-700">çæ‡²ç¨®é¡ (æ•˜çå…§å®¹)</label>
                            <select id="reward" name="reward" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-blue-500 focus:ring-blue-500">
                                <option value="">è«‹é¸æ“‡</option>
                                <option value="å˜‰çä¸€æ¬¡">å˜‰çä¸€æ¬¡</option>
                                <option value="å˜‰çäºŒæ¬¡">å˜‰çäºŒæ¬¡</option>
                                <option value="è¨˜åŠŸä¸€æ¬¡">è¨˜åŠŸä¸€æ¬¡</option>
                                <option value="è¨˜åŠŸäºŒæ¬¡">è¨˜åŠŸäºŒæ¬¡</option>
                                <option value="ç„¡æ•˜ç(åƒ…è¡¨æš)">ç„¡æ•˜ç(åƒ…è¡¨æš)</option>
                            </select>
                        </div>

                        <button type="submit" class="w-full flex justify-center items-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                            <i data-lucide="plus-circle" class="w-5 h-5 mr-2"></i>
                            åŠ å…¥åå–®
                        </button>
                    </form>
                </div>
            </div>

            <!-- ä¸­é–“ï¼šå·²å¡«å ±åå–®åˆ—è¡¨ -->
            <div class="lg:col-span-2">
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 h-full">
                    <h2 class="text-2xl font-bold text-gray-700 mb-6 flex justify-between items-center">
                        å·²å¡«å ±åå–® (å…± <span id="award-count" class="text-blue-600">0</span> ç­†)
                    </h2>

                    <div id="award-list" class="space-y-4 max-h-[400px] overflow-y-auto pr-2 scrollable-content">
                        <p id="loading-message" class="text-center text-gray-500">è¼‰å…¥åå–®ä¸­...</p>
                    </div>
                    
                    <hr class="my-6">
                    
                    <h3 class="text-xl font-bold text-gray-700 mb-4">æ–‡ä»¶ç”¢å‡º</h3>
                    <div class="flex space-x-4">
                        <button id="generate-script-btn" class="flex-1 py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out disabled:bg-gray-400" disabled>
                            <i data-lucide="mic" class="w-5 h-5 inline-block mr-2"></i>
                            ä¸€ä»¶ç”¢å‡ºå¸å„€ç¨¿
                        </button>
                        <button id="generate-notice-btn" class="flex-1 py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out disabled:bg-gray-400" disabled>
                            <i data-lucide="file-text" class="w-5 h-5 inline-block mr-2"></i>
                            ä¸€ä»¶ç”¢å‡ºæ•˜çå…¬å‘Š (å»ºè­°è¡¨æ ¼å¼)
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Document Display -->
<div id="document-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
        <div class="p-6 border-b flex justify-between items-center">
            <h2 id="modal-title" class="text-2xl font-bold text-gray-800">æ–‡ä»¶ç”Ÿæˆ</h2>
            <button id="close-modal-btn" class="text-gray-500 hover:text-gray-700">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
        
        <div class="p-6 flex-grow overflow-hidden">
            <!-- ä½¿ç”¨ innerHTML å‘ˆç¾ HTML æ ¼å¼ï¼Œé©åˆè¤‡è£½è²¼ä¸Šåˆ° Google æ–‡ä»¶ -->
            <div class="h-full bg-gray-50 p-4 rounded-lg overflow-y-auto scrollable-content border border-gray-200">
                <div id="document-content" class="text-sm leading-relaxed text-gray-800"></div>
            </div>
        </div>

        <div class="p-4 border-t flex justify-between">
            <!-- PDF ç”ŸæˆæŒ‰éˆ• -->
            <button id="generate-pdf-btn" class="flex items-center py-2 px-4 rounded-md text-sm font-medium text-white bg-red-600 hover:bg-red-700 transition duration-150 ease-in-out">
                <i data-lucide="file-text" class="w-5 h-5 mr-2"></i>
                ç”¢ç”Ÿ PDF æ–‡ä»¶
            </button>
            <!-- å»ºè­°æ‰‹å‹•é¸å–å…§å®¹è²¼åˆ° Google æ–‡ä»¶ä»¥ä¿ç•™æ ¼å¼ -->
            <button id="copy-document-btn" class="flex items-center py-2 px-4 rounded-md text-sm font-medium text-white bg-teal-600 hover:bg-teal-700 transition duration-150 ease-in-out">
                <i data-lucide="clipboard" class="w-5 h-5 mr-2"></i>
                è¤‡è£½æ–‡ä»¶å…§å®¹ (ç´”æ–‡å­—)
            </button>
        </div>
    </div>
</div>

<!-- Firebase Scripts -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // è¨­å®š Firebase Log Level
    setLogLevel('Debug');

    // å…¨åŸŸè®Šæ•¸åˆå§‹åŒ–
    let db;
    let auth;
    let userId;
    let awardees = [];
    let isFirebaseReady = false; // æ–°å¢ç‹€æ…‹æ——æ¨™
    
    // --- Firestore å¿…å‚™è®Šæ•¸èˆ‡åˆå§‹åŒ–é‚è¼¯ ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // 2. ç²å– Collection Path (å…¬å…±è³‡æ–™)
    const getAwardeesCollectionPath = () => {
        // ä½¿ç”¨å…¬å…±é›†åˆï¼Œæ–¹ä¾¿å¤šäººå”ä½œæˆ–æŸ¥é–±
        return `artifacts/${appId}/public/data/awardees`;
    };

    /**
     * æ ¹æ“šçæ‡²ç¨®é¡è‡ªå‹•åˆ¤æ–·æ³•æ¢ä¾æ“šã€‚
     * @param {string} reward - çæ‡²ç¨®é¡ (e.g., 'å˜‰çä¸€æ¬¡', 'è¨˜åŠŸäºŒæ¬¡').
     * @returns {string} æ³•æ¢ä¾æ“š (e.g., 'ç¬¬å››æ¢ç¬¬åå…­æ¬¾').
     */
    const getBasis = (reward) => {
        if (reward.includes('å˜‰ç')) {
            return 'ç¬¬å››æ¢ç¬¬åå…­æ¬¾';
        } else if (reward.includes('è¨˜åŠŸ')) {
            // è¨˜åŠŸ (Minor Merit)
            return 'ç¬¬äº”æ¢ç¬¬åäºŒæ¬¾';
        } else {
            return 'ç„¡'; // 'ç„¡æ•˜ç(åƒ…è¡¨æš)'
        }
    };


    if (Object.keys(firebaseConfig).length > 0) {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        
        // 1. è™•ç†èº«ä»½é©—è­‰
        const authenticateUser = async () => {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-info').innerHTML = 
                            `<i data-lucide="user" class="w-4 h-4 inline-block mr-1"></i> ç”¨æˆ¶ ID (ç”¨æ–¼å…±äº«/è¿½è¹¤): <span class="font-mono text-gray-700">${userId}</span>`;
                        isFirebaseReady = true; // Firebase æœå‹™å·²å°±ç·’
                        document.getElementById('auth-status').textContent = ''; // æ¸…é™¤éŒ¯èª¤è¨Šæ¯
                        lucide.createIcons(); // é‡æ–°æ¸²æŸ“ Lucide åœ–ç¤º
                        initializeListeners();
                    } else {
                        isFirebaseReady = false;
                        document.getElementById('auth-status').textContent = 'èªè­‰å¤±æ•—ï¼Œè«‹é‡æ–°è¼‰å…¥ã€‚';
                    }
                });
            } catch (error) {
                console.error("Firebase Authentication Error:", error);
                isFirebaseReady = false;
                document.getElementById('auth-status').textContent = `èªè­‰éŒ¯èª¤: ${error.message}`;
            }
        };

        // 3. å¯¦æ™‚ç›£è½è³‡æ–™åº«
        const initializeListeners = () => {
            if (!db || !isFirebaseReady) { 
                document.getElementById('loading-message').textContent = 'ç­‰å¾… Firebase é€£æ¥...';
                return;
            }
            
            const awardeesCollectionRef = collection(db, getAwardeesCollectionPath());
            
            // ç›£è½åå–®è®Šå‹•
            onSnapshot(awardeesCollectionRef, (snapshot) => {
                awardees = [];
                snapshot.forEach((doc) => {
                    awardees.push({ id: doc.id, ...doc.data() });
                });
                // ä¾ç­ç´š/åº§è™Ÿæ’åº
                awardees.sort((a, b) => {
                    if (a.class < b.class) return -1;
                    if (a.class > b.class) return 1;
                    return (a.seatNo || 0) - (b.seatNo || 0);
                });
                renderAwardList();
            }, (error) => {
                console.error("Error listening to awardees:", error);
                document.getElementById('loading-message').textContent = 'è¼‰å…¥åå–®å¤±æ•—ã€‚';
            });
        };

        // å•Ÿå‹•èªè­‰
        authenticateUser();

    } else {
        // ç•¶é…ç½®éºå¤±æ™‚ï¼Œé¡¯ç¤ºéŒ¯èª¤ä¸¦å°‡ isFirebaseReady è¨­ç‚º false
        document.getElementById('auth-status').textContent = 'Firebase é…ç½®éºå¤±ï¼Œè«‹æª¢æŸ¥è¨­å®šã€‚';
        document.getElementById('loading-message').textContent = 'Firebase æœªåˆå§‹åŒ–ã€‚';
        isFirebaseReady = false;
    }
    // --- çµæŸ Firebase å¿…å‚™é‚è¼¯ ---

    // --- è¼”åŠ©å‡½å¼èˆ‡ DOM å…ƒç´ å­˜å– ---
    const form = document.getElementById('award-form');
    const awardListContainer = document.getElementById('award-list');
    const awardCountSpan = document.getElementById('award-count');
    const generateScriptBtn = document.getElementById('generate-script-btn');
    const generateNoticeBtn = document.getElementById('generate-notice-btn');
    
    // Modal å…ƒç´ 
    const modal = document.getElementById('document-modal');
    const modalTitle = document.getElementById('modal-title');
    const documentContent = document.getElementById('document-content');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const copyDocumentBtn = document.getElementById('copy-document-btn');
    const generatePdfBtn = document.getElementById('generate-pdf-btn'); // æ–°å¢ PDF æŒ‰éˆ•

    // æ ¼å¼åŒ–ç™¼ç”Ÿæ—¥æœŸç‚º æœˆ/æ—¥
    const formatEventDate = (dateString) => {
        if (!dateString) return '';
        const date = new Date(dateString);
        // ä½¿ç”¨ getMonth() + 1 å’Œ getDate()
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        return `${month} / ${day}`;
    };
    
    // æ¸²æŸ“åå–®åˆ—è¡¨
    const renderAwardList = () => {
        awardListContainer.innerHTML = '';
        awardCountSpan.textContent = awardees.length;

        generateScriptBtn.disabled = awardees.length === 0 || !isFirebaseReady;
        generateNoticeBtn.disabled = awardees.length === 0 || !isFirebaseReady;

        if (awardees.length === 0) {
            awardListContainer.innerHTML = '<p class="text-center text-gray-500 p-4 bg-gray-50 rounded-lg">å°šç„¡ç²çåå–®ï¼Œè«‹ä½¿ç”¨ä¸Šæ–¹è¡¨å–®æ–°å¢ã€‚</p>';
            return;
        }

        awardees.forEach(item => {
            // ç”±æ–¼ basis ç¾åœ¨æ˜¯å¾Œç«¯ç”Ÿæˆï¼Œç¢ºä¿å®ƒå­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨å‰‡ä½¿ç”¨ getBasis é‡æ–°è¨ˆç®—ï¼ˆæ‡‰æ€¥ï¼‰
            const basisText = item.basis || getBasis(item.reward);
            
            const div = document.createElement('div');
            div.className = 'bg-gray-50 p-4 rounded-lg shadow-sm flex justify-between items-center transition hover:bg-gray-100';
            div.innerHTML = `
                <div>
                    <p class="text-base font-semibold text-blue-700">${item.class} ${item.seatNo} è™Ÿ ${item.name}</p>
                    <p class="text-xs text-gray-600 mt-1">
                        <span class="inline-block bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full">${item.reward}</span>
                        <span class="inline-block bg-gray-200 text-gray-600 text-xs font-medium px-2.5 py-0.5 rounded-full">${basisText}</span>
                        <span class="inline-block bg-gray-200 text-gray-600 text-xs font-medium px-2.5 py-0.5 rounded-full">${formatEventDate(item.eventDate)}</span>
                        ${item.reason}
                    </p>
                </div>
                <button data-id="${item.id}" class="delete-btn text-red-500 hover:text-red-700 ml-4 p-1 rounded-full hover:bg-red-100 transition">
                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                </button>
            `;
            awardListContainer.appendChild(div);
        });
        lucide.createIcons(); // æ¸²æŸ“åˆªé™¤æŒ‰éˆ•åœ–ç¤º
    };

    // --- è¡¨å–®æäº¤èˆ‡è³‡æ–™å¯«å…¥ ---
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (!isFirebaseReady) {
            console.error("Firebase is not initialized. Cannot submit data.");
            document.getElementById('auth-status').textContent = 'Firebase é€£æ¥éŒ¯èª¤ï¼Œè«‹ç¨å¾Œé‡è©¦ã€‚';
            return;
        }
        
        const formData = new FormData(form);
        const rewardValue = formData.get('reward');

        const newAward = {
            class: formData.get('class').trim(),
            seatNo: parseInt(formData.get('seatNo'), 10),
            name: formData.get('name').trim(),
            eventDate: formData.get('eventDate'),
            reason: formData.get('reason').trim(),
            reward: rewardValue,
            basis: getBasis(rewardValue) // <<< è‡ªå‹•åˆ¤æ–·æ³•æ¢ä¾æ“š
        };
        
        if (!db) {
            console.error("Firestore is not initialized.");
            return;
        }

        try {
            // å¯¦ä½œæŒ‡æ•¸é€€é¿é‡è©¦æ©Ÿåˆ¶
            const maxRetries = 3;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const docRef = await addDoc(collection(db, getAwardeesCollectionPath()), newAward);
                    console.log("Document written with ID: ", docRef.id);
                    form.reset();
                    break; // æˆåŠŸå¾Œè·³å‡ºè¿´åœˆ
                } catch (error) {
                    if (i === maxRetries - 1) throw error; // æœ€å¾Œä¸€æ¬¡å˜—è©¦å¤±æ•—ï¼Œæ‹‹å‡ºéŒ¯èª¤
                    console.warn(`Attempt ${i + 1} failed, retrying in ${Math.pow(2, i)}s...`);
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                }
            }
        } catch (error) {
            console.error("Error adding document: ", error);
            // æ›¿æ› alert ç‚ºè‡ªå®šç¾© Modal è¨Šæ¯æˆ– console.errorï¼Œä½†æ­¤è™•ç‚ºåŠŸèƒ½å±•ç¤ºï¼Œæš«æ™‚ä¿ç•™ç°¡åŒ–è¨Šæ¯
            console.error('æ–°å¢åå–®å¤±æ•—ï¼Œè«‹æª¢æŸ¥é€£ç·šæˆ–è¨­å®šã€‚'); 
        }
    });
    
    // --- åˆªé™¤åŠŸèƒ½ ---
    awardListContainer.addEventListener('click', async (e) => {
        const deleteBtn = e.target.closest('.delete-btn');
        if (deleteBtn) {
            const docId = deleteBtn.getAttribute('data-id');
            // æ›¿æ› confirm() è­¦å‘Šçª—ï¼Œå¯¦éš›æ‡‰ç”¨ä¸­æ‡‰ä½¿ç”¨è‡ªå®šç¾© Modal
            if (window.confirm(`ç¢ºå®šè¦åˆªé™¤é€™ç­†ç²çè³‡æ–™å—ï¼Ÿ`)) { 
                if (!db || !isFirebaseReady) {
                    console.error("Firebase is not ready. Cannot delete data.");
                    return;
                }
                try {
                     // å¯¦ä½œæŒ‡æ•¸é€€é¿é‡è©¦æ©Ÿåˆ¶
                    const maxRetries = 3;
                    for (let i = 0; i < maxRetries; i++) {
                        try {
                            const docRef = doc(db, getAwardeesCollectionPath(), docId);
                            await deleteDoc(docRef);
                            break; // æˆåŠŸå¾Œè·³å‡ºè¿´è¿´
                        } catch (error) {
                            if (i === maxRetries - 1) throw error; // æœ€å¾Œä¸€æ¬¡å˜—è©¦å¤±æ•—ï¼Œæ‹‹å‡ºéŒ¯èª¤
                            console.warn(`Attempt ${i + 1} failed, retrying in ${Math.pow(2, i)}s...`);
                            await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                        }
                    }
                } catch (error) {
                    console.error("Error removing document: ", error);
                    // æ›¿æ› alert è¨Šæ¯
                    console.error('åˆªé™¤åå–®å¤±æ•—ã€‚');
                }
            }
        }
    });

    // --- æ–‡ä»¶è‡ªå‹•ç”Ÿæˆé‚è¼¯ (æ ¸å¿ƒ) ---
    
    // å¸å„€ç¨¿ç”Ÿæˆ (è¼¸å‡º HTML æ ¼å¼)
    const generateEmceeScript = () => {
        let script = "<h2>ğŸ† é ’çå…¸ç¦®å¸å„€ç¨¿ (å½™æ•´è‰ç¨¿)</h2><p style='color: #ef4444;'>è«‹æ‰‹å‹•é¸å–å…§å®¹è¤‡è£½ï¼Œè²¼è‡³ Google æ–‡ä»¶ä»¥ä¿ç•™æ ¼å¼ã€‚</p><hr class='my-4 border-gray-300'>";
        script += "<p style='font-style: italic; color: #4b5563;'>--- å…¸ç¦®é–‹å§‹ | å¸å„€å£å» ---</p><br>";
        
        awardees.forEach((item, index) => {
            // æ ¼å¼: [ç­ç´š] ç­ [å§“å] [å¾—çåŸå› ]ï¼Œæ­è«‹æ ¡é•·é ’çï¼
            const template = `<div style="margin-bottom: 20px; padding: 15px; border-left: 5px solid #3b82f6; background-color: #eff6ff; border-radius: 5px;">` +
                             `<p style="font-size: 1.2em; line-height: 1.6; font-weight: 700;">` +
                             `<b>${item.class} ç­ ${item.name}</b>` +
                             ` ${item.reason}ï¼Œ` + 
                             `æ­è«‹æ ¡é•·é ’çï¼` +
                             `</p>` +
                             `<p style="font-style: italic; color: #4b5563; margin-top: 5px; font-size: 0.9em;">(${index + 1}. è«‹æ…¢é€Ÿã€æ¸…æ™°åœ°å®£è®€)</p>` +
                             `</div>`;
            script += template;
        });

        script += "<p style='font-style: italic; color: #4b5563;'>--- é ’çç’°ç¯€çµæŸï¼Œè«‹æŒè²é¼“å‹µæ‰€æœ‰ç²çåŒå­¸ï¼ ---</p>";
        return script;
    };

    // æ•˜çé€šçŸ¥ç”Ÿæˆ (è¼¸å‡º HTML è¡¨æ ¼æ ¼å¼ - ä¾æ“šä½¿ç”¨è€…æä¾›çš„åœ–è¡¨)
    const generateCommendationNotice = () => {
        const tableCellStyle = "border: 1px solid black; padding: 8px; vertical-align: middle; white-space: normal;";
        
        // å–å¾—ç•¶å‰æ—¥æœŸ (ç”¨æ–¼æ¨¡æ“¬ç™¼æ–‡æ—¥æœŸï¼Œéœ€æ‰‹å‹•ä¿®æ”¹å¹´ä»½)
        const currentDate = new Date();
        const year = currentDate.getFullYear() - 1911; // è½‰æ›ç‚ºæ°‘åœ‹å¹´ (ç¯„ä¾‹)
        const month = (currentDate.getMonth() + 1).toString().padStart(2, '0');
        const day = currentDate.getDate().toString().padStart(2, '0');
        const dateHeader = `ä¸­è¯æ°‘åœ‹ ${year} å¹´ ${month} æœˆ ${day} æ—¥`;

        let notice = `<div style="padding: 20px; font-family: 'Noto Sans TC', sans-serif; max-width: 100%; overflow-x: auto;">
            <p style='color: #ef4444; margin-bottom: 20px;'>è«‹æ‰‹å‹•é¸å–å…§å®¹è¤‡è£½ï¼Œè²¼è‡³ Google æ–‡ä»¶ä»¥ä¿ç•™æ ¼å¼ã€‚</p>
            <h2 style="font-size: 1.5em; font-weight: bold; text-align: center; margin-bottom: 10px;">è‡ºä¸­å¸‚ç«‹å¤§ç”²åœ‹æ°‘ä¸­å­¸å­¸ç”Ÿçæ‡²å»ºè­°è¡¨(å…¬å‘Š)</h2>
            <div style="text-align: right; margin-bottom: 15px; font-size: 0.9em;">${dateHeader} (è«‹ä¿®æ”¹ç‚ºå…¬å‘Šæ—¥æœŸ)</div>

            <table style="width: 100%; border-collapse: collapse; text-align: center; font-size: 0.9em; border: 2px solid black;">
                <thead>
                    <tr style="background-color: #f0f0f0; font-weight: bold; height: 50px;">
                        <td style="${tableCellStyle} width: 7%;">ç­ç´š</td>
                        <td style="${tableCellStyle} width: 7%;">åº§è™Ÿ</td>
                        <td style="${tableCellStyle} width: 10%;">å§“å</td>
                        <!-- ä¾æ“šç¯„æœ¬ï¼Œå°‡æ—¥æœŸæ‹†åˆ†ç‚º æœˆ/æ—¥ å…©æ¬„ -->
                        <td style="${tableCellStyle} width: 5%;">ç™¼ç”Ÿæ—¥æœŸ<br>æœˆ</td>
                        <td style="${tableCellStyle} width: 5%;">ç™¼ç”Ÿæ—¥æœŸ<br>æ—¥</td>
                        <td style="${tableCellStyle} width: 35%;">äº‹ç”±</td>
                        <!-- ä¾æ“šç¯„æœ¬ï¼Œç°¡åŒ–æ¢æ¬¾æ¬„ä½åç¨± -->
                        <td style="${tableCellStyle} width: 15%;">ä¾æ“šçæ‡²æ³•<br>æ¢ã€æ¬¾</td>
                        <td style="${tableCellStyle} width: 12%;">çæ‡²ç¨®é¡</td>
                        <td style="${tableCellStyle} width: 9%;">æœƒç°½ï¼šæœ‰é—œå°å¸«</td>
                    </tr>
                </thead>
                <tbody>`;

        if (awardees.length === 0) {
            // ç”±æ–¼æ¬„ä½å¢åŠ ï¼Œcolspan æ‡‰ç‚º 9
            notice += `<tr><td style="${tableCellStyle} height: 40px;" colspan="9">è«‹å…ˆæ–°å¢ç²çåŒå­¸è³‡æ–™ã€‚</td></tr>`; 
        } else {
            awardees.forEach(item => {
                const formattedDate = formatEventDate(item.eventDate);
                const [itemMonth, itemDay] = formattedDate.split(' / ');
                // ç¢ºä¿ basis å­˜åœ¨ï¼Œè‹¥è³‡æ–™åº«ä¸­æœªå­˜(èˆŠè³‡æ–™)ï¼Œå‰‡é‡æ–°è¨ˆç®—
                const basisText = item.basis || getBasis(item.reward);

                notice += `<tr style="height: 40px;">
                    <td style="${tableCellStyle}">${item.class}</td>
                    <td style="${tableCellStyle}">${item.seatNo}</td>
                    <td style="${tableCellStyle}">${item.name}</td>
                    <!-- åˆ†åˆ¥å¡«å…¥æœˆå’Œæ—¥ -->
                    <td style="${tableCellStyle} text-align: center;">${itemMonth}</td>
                    <td style="${tableCellStyle} text-align: center;">${itemDay}</td>
                    <td style="${tableCellStyle} text-align: left; padding-left: 10px;">${item.reason}</td>
                    <td style="${tableCellStyle}">${basisText}</td>
                    <td style="${tableCellStyle} font-weight: bold;">${item.reward}</td>
                    <td style="${tableCellStyle}"></td> <!-- æœƒç°½: ç•™ç©º -->
                </tr>`;
            });
        }

        // çµå°¾ç°½æ ¸å€ - ä¿æŒä¸è®Šï¼Œèˆ‡ç¯„æœ¬ä¸€è‡´
        notice += `</tbody></table>
        
        <div style="margin-top: 30px; font-size: 0.9em;">
            <p style="text-align: center; margin-bottom: 15px; font-weight: bold; padding: 10px 0; border-top: 1px solid black; border-bottom: 1px solid black;">
                å°å¸«æœƒç°½å¾Œè«‹è½‰çŸ¥å­¸ç”Ÿèˆ‡å®¶é•·ï¼Œå¦‚æœ‰å•é¡Œè«‹æ´½å­¸å‹™è™•ç”Ÿæ´»æ•™è‚²çµ„ã€‚
            </p>
            <table style="width: 100%; border: none; border-collapse: collapse; text-align: center;">
                <tr>
                    <td style="width: 25%; border: none; padding: 20px 0;"><b>ç°½å ±äººï¼š</b></td>
                    <td style="width: 25%; border: none;"><b>ç”Ÿæ´»æ•™è‚²çµ„é•·ï¼š</b></td>
                    <td style="width: 25%; border: none;"><b>å­¸å‹™ä¸»ä»»ï¼š</b></td>
                    <td style="width: 25%; border: none;"><b>æ ¡ é•·ï¼š</b></td>
                </tr>
            </table>
        </div>
        </div>`;
        
        return notice;
    };
    
    // é¡¯ç¤º Modal
    const showModal = (title, content) => {
        modalTitle.textContent = title;
        // ä½¿ç”¨ innerHTML å‘ˆç¾ HTML æ ¼å¼
        documentContent.innerHTML = content; 
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        lucide.createIcons();
    };

    // éš±è— Modal
    const hideModal = () => {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    };
    
    /**
     * PDF ç”Ÿæˆå‡½å¼
     * @param {string} filename - æª”æ¡ˆåç¨±
     */
    const generatePDF = (filename) => {
        // å–å¾—è¦è½‰æ›çš„å…§å®¹å®¹å™¨
        const element = document.getElementById('document-content');
        
        // ç‚ºäº†ç¢ºä¿ PDF å…§æ–‡æ ¼å¼æ­£ç¢ºï¼Œæˆ‘å€‘ä½¿ç”¨ä¸€å€‹ç¨ç«‹çš„ Div ä¾†åŒ…è£ï¼Œé¿å…å½±éŸ¿åŸå§‹æ’ç‰ˆ
        const printContent = document.createElement('div');
        printContent.innerHTML = element.innerHTML;
        
        // é…ç½®é¸é …
        const opt = {
            margin: 10,
            filename: filename,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { 
                scale: 2, 
                logging: false,
                // å˜—è©¦å•Ÿç”¨å­—é«”æ¸²æŸ“ï¼Œå¹«åŠ©ä¸­æ–‡å­—é«”è™•ç†
                allowTaint: true,
                useCORS: false
            },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        // ä½¿ç”¨ html2pdf å‡½å¼åº«é€²è¡Œè½‰æ›å’Œä¸‹è¼‰
        // æ³¨æ„ï¼šä¸­æ–‡å­—é«”æ¸²æŸ“æ•ˆæœå¯èƒ½å› ç€è¦½å™¨å’Œå‡½å¼åº«é™åˆ¶è€Œç•°ã€‚
        html2pdf().set(opt).from(printContent).save();
    };

    // è¤‡è£½æ–‡å­—åŠŸèƒ½ (æ­¤åŠŸèƒ½ä»ç¶­æŒè¤‡è£½ç´”æ–‡å­—)
    const copyToClipboard = (text) => {
        // ç‚ºäº†ç¢ºä¿è¤‡è£½ rich textï¼Œæˆ‘å€‘å°‡è¤‡è£½çš„å…§å®¹æ”¹ç‚º documentContent.innerText (ç´”æ–‡å­—)
        const pureText = documentContent.innerText || documentContent.textContent;
        // ä½¿ç”¨ document.execCommand('copy') ä½œç‚º iframe ç’°å¢ƒä¸­çš„å…¼å®¹å¯«æ³•
        const textarea = document.createElement('textarea');
        textarea.value = pureText;
        textarea.style.position = 'fixed'; // é˜²æ­¢é é¢æ»¾å‹•
        textarea.style.opacity = 0;
        document.body.appendChild(textarea);
        textarea.select();
        try {
            const successful = document.execCommand('copy');
            if (successful) {
                copyDocumentBtn.textContent = 'å·²è¤‡è£½!';
                setTimeout(() => {
                    copyDocumentBtn.innerHTML = '<i data-lucide="clipboard" class="w-5 h-5 mr-2"></i>è¤‡è£½æ–‡ä»¶å…§å®¹ (ç´”æ–‡å­—)';
                    lucide.createIcons();
                }, 1500);
            } else {
                console.error('Copy failed');
            }
        } catch (err) {
            console.error('Fallback: Copy failed', err);
        }
        document.body.removeChild(textarea);
    };

    // --- äº‹ä»¶ç›£è½ ---
    generateScriptBtn.addEventListener('click', () => {
        const script = generateEmceeScript();
        showModal('è‡ªå‹•ç”Ÿæˆï¼šå¸å„€ç¨¿', script);
    });

    generateNoticeBtn.addEventListener('click', () => {
        const notice = generateCommendationNotice();
        showModal('è‡ªå‹•ç”Ÿæˆï¼šæ•˜çå…¬å‘Š (å»ºè­°è¡¨æ ¼å¼)', notice);
    });
    
    closeModalBtn.addEventListener('click', hideModal);
    
    copyDocumentBtn.addEventListener('click', () => {
        // è¤‡è£½ç´”æ–‡å­—å…§å®¹
        copyToClipboard(documentContent.innerText);
    });

    // æ–°å¢ PDF ç”ŸæˆæŒ‰éˆ•çš„äº‹ä»¶ç›£è½
    generatePdfBtn.addEventListener('click', () => {
        const title = modalTitle.textContent.replace('è‡ªå‹•ç”Ÿæˆï¼š', '');
        generatePDF(`${title}_${Date.now()}.pdf`);
    });

    // åˆå§‹åŒ– Lucide Icons
    window.onload = () => {
        lucide.createIcons();
    };

</script>
</body>
</html>
